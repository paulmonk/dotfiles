#!/usr/bin/env bash
#
# Export instincts to a tarball.
#
# Usage: export [--min-confidence N] [--output FILE]

set -o errexit -o errtrace -o pipefail -o nounset

readonly HOMUNCULUS_DIR="${HOME}/.claude/homunculus"
readonly INSTINCTS_DIR="${HOMUNCULUS_DIR}/instincts/personal"
readonly EXPORTS_DIR="${HOMUNCULUS_DIR}/exports"

# Prints usage information.
usage() {
  cat <<'EOF'
Usage: export [OPTIONS]

Options:
  --min-confidence N   Only export instincts with confidence >= N (default: 0.5)
  --output FILE        Output path (default: ~/.claude/homunculus/exports/instincts-TIMESTAMP.tar.gz)
  -h, --help           Show this help
EOF
}

# Exports instincts matching confidence threshold to a tarball.
#
# Arguments:
#   $@ - Command line arguments ([--min-confidence N] [--output FILE] [-h|--help])
main() {
  local min_confidence="0.5"
  local output=""

  while [[ $# -gt 0 ]]; do
    case "${1}" in
    --min-confidence)
      min_confidence="${2}"
      shift 2
      ;;
    --output)
      output="${2}"
      shift 2
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: ${1}" >&2
      usage >&2
      exit 1
      ;;
    esac
  done

  # Default output path
  if [[ -z "${output}" ]]; then
    local timestamp
    timestamp=$(date +%Y%m%d-%H%M%S)
    output="${EXPORTS_DIR}/instincts-${timestamp}.tar.gz"
  fi

  mkdir -p "${EXPORTS_DIR}"

  # Create temp dir for filtered instincts
  local tmpdir
  tmpdir=$(mktemp -d)
  trap 'rm -rf "${tmpdir}"' EXIT

  local count=0
  for f in "${INSTINCTS_DIR}"/*.md; do
    [[ -f "${f}" ]] || continue

    local confidence
    confidence=$(grep "^confidence:" "${f}" | cut -d: -f2 | tr -d ' ')

    if [[ "$(echo "${confidence} >= ${min_confidence}" | bc)" -eq 1 ]]; then
      cp "${f}" "${tmpdir}/"
      ((count++))
    fi
  done

  if [[ "${count}" -eq 0 ]]; then
    echo "No instincts match criteria (min confidence: ${min_confidence})" >&2
    exit 1
  fi

  tar -czf "${output}" -C "${tmpdir}" .

  echo "Exported ${count} instincts to: ${output}"
  echo "Import with: /homunculus-instinct-import ${output}"
}

main "$@"
