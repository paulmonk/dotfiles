#!/usr/bin/env bash
#
# Show homunculus system status: health, counts, and instinct details.

set -o errexit -o errtrace -o pipefail -o nounset

readonly HOMUNCULUS_DIR="${HOME}/.claude/homunculus"
readonly IDENTITY_FILE="${HOMUNCULUS_DIR}/identity.json"
readonly INSTINCTS_DIR="${HOMUNCULUS_DIR}/instincts/personal"

# Counts markdown files in a directory.
count_files() {
  local dir="${1}"
  find "${dir}" -maxdepth 1 -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' '
}

# Outputs instinct metadata as tab-separated values.
list_instincts() {
  local filter_domain="${1:-}"

  for f in "${INSTINCTS_DIR}"/*.md; do
    [[ -f ${f} ]] || continue

    local name confidence domain trigger promoted
    name=$(basename "${f}" .md)
    confidence=$(sed -n 's/^confidence: *//p' "${f}" | head -1)
    domain=$(sed -n 's/^domain: *//p' "${f}" | tr -d '"' | head -1)
    trigger=$(sed -n 's/^trigger: *//p' "${f}" | sed 's/^"//;s/"$//' | head -1)
    promoted=$(grep -c "^promoted: true" "${f}" 2>/dev/null || true)

    [[ -z ${filter_domain} || ${domain} == "${filter_domain}" ]] || continue

    local status=""
    if [[ ${promoted} -gt 0 ]]; then
      status=" [promoted]"
    fi

    printf "%s\t%s\t%s\t%s%s\n" "${domain}" "${confidence}" "${name}" "${trigger}" "${status}"
  done | sort
}

# Shows system overview: directories, counts, pending work.
show_overview() {
  echo "=== Homunculus Status ==="
  echo ""

  # Directory check
  echo "Directories:"
  local dirs=(
    "conversations"
    "convictions"
    "episodes"
    "instincts/personal"
    "logs"
    "observations"
    "observations.archive"
    "sessions"
  )
  for dir in "${dirs[@]}"; do
    if [[ -d "${HOMUNCULUS_DIR}/${dir}" ]]; then
      echo "  [x] ${dir}"
    else
      echo "  [ ] ${dir} (missing)"
    fi
  done
  echo ""

  # Session count
  if [[ -f ${IDENTITY_FILE} ]]; then
    local sessions
    sessions=$(jq -r '.session_count // 0' "${IDENTITY_FILE}")
    echo "Sessions: ${sessions}"
  else
    echo "Sessions: (no identity.json)"
  fi

  # Counts
  echo ""
  echo "Instincts: $(count_files "${INSTINCTS_DIR}")"
  echo "Conversations: $(count_files "${HOMUNCULUS_DIR}/conversations")"
  echo "Episodes: $(count_files "${HOMUNCULUS_DIR}/episodes")"
  echo "Sessions: $(count_files "${HOMUNCULUS_DIR}/sessions")"

  local convictions_dir="${HOMUNCULUS_DIR}/convictions"
  if [[ -d ${convictions_dir} ]]; then
    echo "Convictions: $(count_files "${convictions_dir}")"
  fi

  # Pending observations
  local obs_dir="${HOMUNCULUS_DIR}/observations"
  if compgen -G "${obs_dir}/*.jsonl" >/dev/null 2>&1; then
    echo ""
    echo "Pending observations: $(cat "${obs_dir}"/*.jsonl 2>/dev/null | wc -l | tr -d ' ')"
  fi

  # Promotion candidates
  if [[ -f ${IDENTITY_FILE} ]]; then
    local ready
    ready=$(jq -r '.promotion.ready // [] | length' "${IDENTITY_FILE}" 2>/dev/null || echo 0)
    if [[ ${ready} -gt 0 ]]; then
      echo ""
      echo "Promotion candidates in: $(jq -r '.promotion.ready | join(", ")' "${IDENTITY_FILE}")"
    fi
  fi
}

main() {
  show_overview
  echo ""
  echo "=== Instincts ==="
  echo ""
  list_instincts "${1:-}"
}

main "$@"
