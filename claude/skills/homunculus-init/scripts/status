#!/usr/bin/env bash
#
# Show homunculus system status.
#
# Displays directory structure, session count, instinct counts, and pending work.

set -o errexit -o errtrace -o pipefail -o nounset

readonly HOMUNCULUS_DIR="${HOME}/.claude/homunculus"
readonly IDENTITY_FILE="${HOMUNCULUS_DIR}/identity.json"

# Counts markdown files in a directory.
#
# Arguments:
#   $1 - Directory path to search
count_files() {
  local dir="${1}"
  find "${dir}" -maxdepth 1 -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' '
}

# Displays system status including directories, session count, and instincts.
#
# Arguments:
#   $@ - Unused, accepts any arguments for compatibility
main() {
  echo "=== Homunculus Status ==="
  echo ""

  # Directory check
  echo "Directories:"
  local dirs=(
    "observations"
    "observations.archive"
    "instincts/personal"
    "instincts/inherited"
    "sessions"
    "episodes"
  )
  for dir in "${dirs[@]}"; do
    if [[ -d "${HOMUNCULUS_DIR}/${dir}" ]]; then
      echo "  [x] ${dir}"
    else
      echo "  [ ] ${dir} (missing)"
    fi
  done
  echo ""

  # Session count
  if [[ -f ${IDENTITY_FILE} ]]; then
    local sessions
    sessions=$(jq -r '.session_count // 0' "${IDENTITY_FILE}")
    echo "Sessions: ${sessions}"
  else
    echo "Sessions: (no identity.json)"
  fi

  # Instinct counts
  echo ""
  echo "Instincts:"
  echo "  Personal:  $(count_files "${HOMUNCULUS_DIR}/instincts/personal")"
  echo "  Inherited: $(count_files "${HOMUNCULUS_DIR}/instincts/inherited")"

  # Pending observations
  local obs_dir="${HOMUNCULUS_DIR}/observations"
  if compgen -G "${obs_dir}/*.jsonl" >/dev/null 2>&1; then
    echo ""
    echo "Pending observations: $(cat "${obs_dir}"/*.jsonl 2>/dev/null | wc -l | tr -d ' ')"
  fi

  # Convictions
  local convictions_file="${HOMUNCULUS_DIR}/convictions.md"
  if [[ -f ${convictions_file} ]]; then
    local conviction_count
    conviction_count=$(grep -c '^- ' "${convictions_file}" 2>/dev/null || echo 0)
    echo ""
    echo "Convictions: ${conviction_count}"
  fi

  # Promoted instincts
  local promoted_count=0
  for f in "${HOMUNCULUS_DIR}/instincts/personal/"*.md; do
    [[ -f $f ]] || continue
    if grep -q "^promoted: true" "$f"; then
      promoted_count=$((promoted_count + 1))
    fi
  done
  if [[ ${promoted_count} -gt 0 ]]; then
    echo "Promoted instincts: ${promoted_count}"
  fi

  # Promotion candidates (meet criteria but not yet promoted)
  if [[ -f ${IDENTITY_FILE} ]]; then
    local ready
    ready=$(jq -r '.promotion.ready // [] | length' "${IDENTITY_FILE}" 2>/dev/null || echo 0)
    if [[ ${ready} -gt 0 ]]; then
      echo ""
      echo "Promotion candidates in: $(jq -r '.promotion.ready | join(", ")' "${IDENTITY_FILE}")"
    fi
  fi
}

main "$@"
