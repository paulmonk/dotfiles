#!/usr/bin/env bash
#
# Initialise the homunculus continuous learning system.
#
# Creates directory structure, identity.json, and verifies hook configuration.

set -o errexit -o errtrace -o pipefail -o nounset

readonly HOMUNCULUS_DIR="${HOME}/.claude/homunculus"
readonly IDENTITY_FILE="${HOMUNCULUS_DIR}/identity.json"
readonly SETTINGS_FILE="${HOME}/.claude/settings.json"

# Creates the full homunculus directory structure.
create_directories() {
  mkdir -p "${HOMUNCULUS_DIR}/conversations"
  mkdir -p "${HOMUNCULUS_DIR}/convictions"
  mkdir -p "${HOMUNCULUS_DIR}/episodes"
  mkdir -p "${HOMUNCULUS_DIR}/instincts/personal"
  mkdir -p "${HOMUNCULUS_DIR}/logs"
  mkdir -p "${HOMUNCULUS_DIR}/observations"
  mkdir -p "${HOMUNCULUS_DIR}/observations.archive"
  mkdir -p "${HOMUNCULUS_DIR}/sessions"
  echo "Created directory structure"
}

# Creates identity.json with initial session count if it doesn't exist.
create_identity() {
  if [[ -f ${IDENTITY_FILE} ]]; then
    echo "identity.json already exists"
    return
  fi

  local timestamp
  timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)

  cat >"${IDENTITY_FILE}" <<EOF
{
  "session_count": 0,
  "created": "${timestamp}"
}
EOF
  echo "Created identity.json"
}

# Checks that the observe hook is configured in settings.json.
verify_hooks() {
  if grep -q "homunculus-observe" "${SETTINGS_FILE}" 2>/dev/null; then
    echo "Hook configured: homunculus-observe"
  else
    echo "WARNING: homunculus-observe hook not found in settings.json" >&2
  fi
}

# Ensures qmd collections exist for each homunculus data directory.
setup_qmd_collections() {
  command -v qmd >/dev/null 2>&1 || return

  local -A collections=(
    [homunculus - instincts]="${HOMUNCULUS_DIR}/instincts/personal"
    [homunculus - sessions]="${HOMUNCULUS_DIR}/sessions"
    [homunculus - episodes]="${HOMUNCULUS_DIR}/episodes"
    [homunculus - conversations]="${HOMUNCULUS_DIR}/conversations"
  )

  local name
  for name in "${!collections[@]}"; do
    qmd collection add "${collections[$name]}" --name "${name}" --mask "*.md" 2>/dev/null || true
  done
  echo "Verified qmd collections"
}

# Runs all initialisation steps.
#
# Arguments:
#   $@ - Unused, accepts any arguments for compatibility
main() {
  create_directories
  create_identity
  verify_hooks
  setup_qmd_collections
}

main "$@"
