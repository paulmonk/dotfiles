#!/usr/bin/env bash
#/ Blocks file edits in main checkout when worktrees are configured.
#/
#/ Repos with a .worktrees/ directory require edits to happen within one.
#/ This enforces development discipline by preventing accidental edits to the
#/ main checkout when worktrees are available.
set -o errexit -o errtrace -o pipefail -o nounset

# shellcheck source=claude/lib/hook-io.sh
source "${HOME}/.claude/lib/hook-io.sh"

main() {
  local input tool_name file_path file_dir file_git_root
  input=$(read_hook_input)

  tool_name=$(echo "${input}" | jq -r '.tool_name // ""')
  case "${tool_name}" in
  Edit | Write | MultiEdit | NotebookEdit) ;;
  *)
    echo "${input}"
    exit 0
    ;;
  esac

  # Resolve the file being edited and its repo root.
  file_path=$(echo "${input}" | jq -r '.tool_input.file_path // ""')
  [[ -z ${file_path} ]] && {
    echo "${input}"
    exit 0
  }

  file_dir=$(dirname "${file_path}")
  file_git_root=$(git -C "${file_dir}" rev-parse --show-toplevel 2>/dev/null || echo "")
  [[ -z ${file_git_root} ]] && {
    echo "${input}"
    exit 0
  }

  # Only enforce if .worktrees/ exists in the file's repo (opt-in).
  [[ ! -d "${file_git_root}/.worktrees" ]] && {
    echo "${input}"
    exit 0
  }

  # Allow if target file is within a worktree.
  [[ ${file_path} == *"/.worktrees/"* ]] && {
    echo "${input}"
    exit 0
  }

  # Allow plan files (plan mode writes here regardless of cwd).
  [[ ${file_path} == *"/.claude/plans/"* ]] && {
    echo "${input}"
    exit 0
  }

  # Allow gitignored files (untracked, safe to edit in main checkout).
  git -C "${file_git_root}" check-ignore -q "${file_path}" 2>/dev/null && {
    echo "${input}"
    exit 0
  }

  # Deny: editing main checkout when worktrees exist.
  deny_tool "Edits require a worktree. Run: wt switch -c <branch-name>"
}

main "$@"
