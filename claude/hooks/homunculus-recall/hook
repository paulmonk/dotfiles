#!/usr/bin/env bash
#
# Mid-session recall hook. After Edit/Write, queries qmd for past sessions
# and episodes involving the same file. Surfaces relevant memories as
# context to inform subsequent decisions.
#
# Runs on PostToolUse (async) for Edit, Write, and MultiEdit.
# Two qmd queries run in parallel to minimise wall-clock time.

set -o errexit -o errtrace -o pipefail -o nounset

readonly SESSIONS_DIR="${HOME}/.claude/homunculus/sessions"
readonly EPISODES_DIR="${HOME}/.claude/homunculus/episodes"

# Resolve qmd:// URIs to real file paths.
resolve_qmd_uri() {
  local collection="$1"
  local base_dir="$2"
  sed "s|^qmd://${collection}/|${base_dir}/|"
}

# Extract memory context from session summary files.
format_session_hits() {
  local hits="$1"
  local hit date project file_name="$2"

  while IFS= read -r hit; do
    [[ -f "${hit}" ]] || continue
    date=$(sed -n 's/^date: *//p' "${hit}" | head -1)
    project=$(sed -n 's/^project: *//p' "${hit}" | head -1)
    if [[ -n "${date}" ]]; then
      printf '[%s] %s: edited %s\n' "${date}" "${project}" "${file_name}"
    fi
  done <<<"${hits}"
}

# Extract memory context from episode files.
format_episode_hits() {
  local hits="$1"
  local hit title

  while IFS= read -r hit; do
    [[ -f "${hit}" ]] || continue
    title=$(sed -n 's/^# *//p' "${hit}" | head -1)
    if [[ -n "${title}" ]]; then
      printf '[episode] %s\n' "${title}"
    fi
  done <<<"${hits}"
}

main() {
  local input file_path file_name

  # Only activate if qmd is available.
  command -v qmd >/dev/null 2>&1 || return

  input=$(cat)
  file_path=$(echo "${input}" | jq -r '.tool_input.file_path // empty' 2>/dev/null)
  [[ -n "${file_path}" ]] || return

  file_name=$(basename "${file_path}")

  # Run both qmd searches in parallel.
  local session_tmp episode_tmp
  session_tmp=$(mktemp)
  episode_tmp=$(mktemp)
  trap 'rm -f "${session_tmp}" "${episode_tmp}"' EXIT

  (qmd search "${file_name}" -c homunculus-sessions -n 3 --files 2>/dev/null |
    awk -F, '{print $3}' |
    resolve_qmd_uri "homunculus-sessions" "${SESSIONS_DIR}" |
    head -3 >"${session_tmp}") &

  (qmd search "${file_name}" -c homunculus-episodes -n 2 --files 2>/dev/null |
    awk -F, '{print $3}' |
    resolve_qmd_uri "homunculus-episodes" "${EPISODES_DIR}" |
    head -2 >"${episode_tmp}") &

  wait

  local memories=""
  local session_hits episode_hits
  session_hits=$(cat "${session_tmp}")
  episode_hits=$(cat "${episode_tmp}")

  if [[ -n "${session_hits}" ]]; then
    memories+=$(format_session_hits "${session_hits}" "${file_name}")
  fi

  if [[ -n "${episode_hits}" ]]; then
    memories+=$(format_episode_hits "${episode_hits}")
  fi

  if [[ -n "${memories}" ]]; then
    printf '[RECALL] Past interactions with %s:\n%s\n' "${file_name}" "${memories}"
  fi
}

main
