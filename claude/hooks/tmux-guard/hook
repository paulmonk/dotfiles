#!/usr/bin/env bash
#/ Blocks background Bash commands outside tmux sessions.
#/
#/ Background tasks detach from Claude's process tree, making their output
#/ unrecoverable if the terminal closes. Tmux provides session persistence.
set -o errexit -o errtrace -o pipefail -o nounset

# shellcheck source=claude/lib/hook-io.sh
source "${HOME}/.claude/lib/hook-io.sh"

main() {
  local input tool_name run_in_background
  input=$(read_hook_input)

  tool_name=$(echo "${input}" | jq -r '.tool_name // ""')
  [[ ${tool_name} != "Bash" ]] && {
    echo "${input}"
    exit 0
  }

  run_in_background=$(echo "${input}" | jq -r '.tool_input.run_in_background // false')
  [[ ${run_in_background} != "true" ]] && {
    echo "${input}"
    exit 0
  }

  if [[ -z ${TMUX:-} ]]; then
    deny_tool "Background tasks require a tmux session. Start tmux first, then retry."
    exit 0
  fi

  echo "${input}"
}

main "$@"
