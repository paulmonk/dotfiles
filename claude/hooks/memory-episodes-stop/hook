#!/usr/bin/env bash
#
# Summarise the session conversation via LLM and save for qmd indexing.
# Always exits 0 to never block session close.

# Note: errexit intentionally omitted so failures don't block session close.
set -o errtrace -o pipefail -o nounset

readonly MEMORY_DIR="${HOME}/.claude/memory-episodes"
readonly LOG_DIR="${HOME}/.claude/logs/memory-episodes"
readonly LOG_FILE="${LOG_DIR}/summariser.log"

command -v jq >/dev/null 2>&1 || exit 0

input=$(cat)
SESSION_CWD=$(echo "${input}" | jq -r '.cwd // empty' 2>/dev/null)
readonly SESSION_CWD
SESSION_ID=$(echo "${input}" | jq -r '.session_id // empty' 2>/dev/null)
readonly SESSION_ID

[[ -n ${SESSION_ID} && -n ${SESSION_CWD} ]] || exit 0

mkdir -p "${LOG_DIR}" 2>/dev/null || true
log() { echo "[$(date -Iseconds)] $1" >>"${LOG_FILE}" 2>/dev/null || true; }

summarise_conversation() {
  # Ensure common install locations are on PATH for backgrounded processes.
  export PATH="/opt/homebrew/bin:/usr/local/bin:${PATH}"

  if ! mkdir -p "${MEMORY_DIR}" 2>/dev/null; then
    echo "memory-episodes: could not create ${MEMORY_DIR}" >&2
    return 1
  fi

  local escaped_cwd
  escaped_cwd=$(echo "${SESSION_CWD}" | tr '/' '-')
  local jsonl="${HOME}/.claude/projects/${escaped_cwd}/${SESSION_ID}.jsonl"
  if [[ ! -f ${jsonl} ]]; then
    log "No session JSONL at ${jsonl}, skipping"
    return 0
  fi

  local dialogue
  dialogue=$(jq -r '
    (.message // empty) |
    if .role == "user" and (.content | type) == "string" and (.content | test("\\S"))
    then "Human: " + .content
    elif .role == "assistant" and (.content | type) == "array"
    then .content[] | select(.type == "text" and (.text | test("\\S"))) | "Assistant: " + .text
    else empty
    end
  ' "${jsonl}" 2>/dev/null)
  if [[ -z ${dialogue} ]]; then
    log "No dialogue extracted from ${jsonl}, skipping"
    return 0
  fi

  # Truncate to stay within haiku's context.
  dialogue=$(head -c 80000 <<<"${dialogue}")

  local project_name file_ts summary_file prompt_file summary timestamp
  project_name=$(basename "${SESSION_CWD:-unknown}")
  file_ts=$(date -u +%Y-%m-%dT%H%M%SZ)
  timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)
  summary_file="${MEMORY_DIR}/${file_ts}-${SESSION_ID:0:7}.md"

  if ! prompt_file=$(mktemp 2>/dev/null); then
    log "mktemp failed, cannot create prompt file"
    return 1
  fi
  trap 'rm -f "${prompt_file}" 2>/dev/null || true' EXIT
  {
    cat <<'PROMPT'
Summarise this Claude Code conversation concisely. Structure:

## Goals
What the user wanted to achieve.

## Decisions
Key choices made and their rationale.

## Outcomes
What was accomplished, what remains.

Keep it under 300 words. Focus on decisions and rationale, not individual tool calls or code.

<conversation>
PROMPT
    echo "${dialogue}"
    echo "</conversation>"
  } >"${prompt_file}"

  summary=$(MAX_THINKING_TOKENS=0 claude -p \
    --model haiku \
    --no-session-persistence \
    --tools '' \
    --disable-slash-commands \
    --setting-sources '' \
    --system-prompt '' \
    <"${prompt_file}" 2>/dev/null)
  if [[ -z ${summary} ]]; then
    log "LLM summarisation returned empty for session ${SESSION_ID:0:7}"
    return 1
  fi

  if ! {
    echo "---"
    echo "date: ${timestamp}"
    echo "project: ${project_name}"
    echo "directory: ${SESSION_CWD:-unknown}"
    echo "session_id: ${SESSION_ID:0:7}"
    echo "type: conversation"
    echo "---"
    echo ""
    echo "# Conversation: ${project_name}"
    echo ""
    echo "${summary}"
  } >"${summary_file}"; then
    log "Failed to write summary to ${summary_file}"
    return 1
  fi

  log "Summarised conversation to $(basename "${summary_file}")"
}

summarise_conversation </dev/null &

exit 0
