#!/usr/bin/env bash
#
# Summarise the session conversation via LLM and save for qmd indexing.
# Always exits 0 to never block session close.
#
# errexit intentionally omitted so failures don't block session close.
set -o errtrace -o pipefail -o nounset

readonly MEMORY_DIR="${HOME}/.claude/memory-episodes"
readonly LOG_DIR="${HOME}/.claude/logs/memory-episodes"
readonly LOG_FILE="${LOG_DIR}/summariser.log"

log() { echo "[$(date -Iseconds)] $*" >>"${LOG_FILE}" 2>/dev/null || true; }

extract_oneliner() {
  local text="$1"
  local line

  # Try ## Goals section: first non-empty line after header.
  line=$(awk '/^## Goals/{found=1; next} found && /\S/{print; exit}' <<<"${text}")
  [[ -n "${line}" ]] && {
    echo "${line:0:200}"
    return
  }

  # Try ## Summary section.
  line=$(awk '/^## Summary/{found=1; next} found && /\S/{print; exit}' <<<"${text}")
  [[ -n "${line}" ]] && {
    echo "${line:0:200}"
    return
  }

  # Fallback: first non-header, non-empty content line.
  line=$(awk '!/^#/ && !/^---/ && !/^$/ && /\S/{print; exit}' <<<"${text}")
  echo "${line:0:200}"
}

append_to_index() {
  local index_file="${MEMORY_DIR}/index.jsonl"
  local date_short goals
  date_short=$(date -u +%Y-%m-%d)
  goals=$(extract_oneliner "${summary}")
  [[ -n "${goals}" ]] || return 0

  jq -c -n \
    --arg date "${date_short}" \
    --arg session_id "${SESSION_ID:0:7}" \
    --arg project "${project_name}" \
    --arg goals "${goals}" \
    '{date: $date, session_id: $session_id, project: $project, goals: $goals}' \
    >>"${index_file}" 2>/dev/null || true
}

summarise_conversation() {
  # Ensure common install locations are on PATH for backgrounded processes.
  export PATH="/opt/homebrew/bin:/usr/local/bin:${PATH}"

  if ! mkdir -p "${MEMORY_DIR}" 2>/dev/null; then
    log "Could not create ${MEMORY_DIR}"
    return 1
  fi

  local escaped_cwd
  escaped_cwd=$(tr '/.' '-' <<<"${SESSION_CWD}")
  local jsonl="${HOME}/.claude/projects/${escaped_cwd}/${SESSION_ID}.jsonl"
  if [[ ! -f ${jsonl} ]]; then
    log "No session JSONL at ${jsonl}, skipping"
    return 0
  fi

  local dialogue
  dialogue=$(jq -r '
    (.message // empty) |
    if .role == "user" and (.content | type) == "string" and (.content | test("\\S"))
    then "Human: " + .content
    elif .role == "assistant" and (.content | type) == "array"
    then .content[] | select(.type == "text" and (.text | test("\\S"))) | "Assistant: " + .text
    else empty
    end
  ' "${jsonl}" 2>/dev/null)
  if [[ -z ${dialogue} ]]; then
    log "No dialogue extracted from ${jsonl}, skipping"
    return 0
  fi

  # Truncate to stay within haiku's context.
  dialogue=$(head -c 80000 <<<"${dialogue}")

  local project_name file_ts summary_file prompt_file summary timestamp
  project_name=$(basename "${SESSION_CWD:-unknown}")
  file_ts=$(date -u +%Y-%m-%dT%H%M%SZ)
  timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)
  summary_file="${MEMORY_DIR}/${file_ts}-${SESSION_ID:0:7}.md"

  if ! prompt_file=$(mktemp 2>/dev/null); then
    log "mktemp failed, cannot create prompt file"
    return 1
  fi
  trap 'rm -f "${prompt_file}" 2>/dev/null || true' EXIT
  {
    cat <<'PROMPT'
Summarise this Claude Code conversation concisely. Structure:

## Goals
What the user wanted to achieve.

## Decisions
Key choices made and their rationale.

## Outcomes
What was accomplished, what remains.

Keep it under 300 words. Focus on decisions and rationale, not individual tool calls or code.

<conversation>
PROMPT
    echo "${dialogue}"
    echo "</conversation>"
  } >"${prompt_file}"

  summary=$(MAX_THINKING_TOKENS=0 claude -p \
    --model haiku \
    --no-session-persistence \
    --tools '' \
    --disable-slash-commands \
    --setting-sources '' \
    --system-prompt '' \
    <"${prompt_file}" 2>/dev/null)
  if [[ -z ${summary} ]]; then
    log "Summarisation returned empty for session ${SESSION_ID:0:7}"
    return 1
  fi

  if ! {
    echo "---"
    echo "date: ${timestamp}"
    echo "project: ${project_name}"
    echo "directory: ${SESSION_CWD:-unknown}"
    echo "session_id: ${SESSION_ID:0:7}"
    echo "type: conversation"
    echo "---"
    echo ""
    echo "# Conversation: ${project_name}"
    echo ""
    echo "${summary}"
  } >"${summary_file}"; then
    log "Failed to write summary to ${summary_file}"
    return 1
  fi

  log "Summarised conversation to $(basename "${summary_file}")"
  append_to_index
}

main() {
  local input
  input=$(cat)
  local session_cwd session_id
  session_cwd=$(jq -r '.cwd // empty' <<<"${input}")
  session_id=$(jq -r '.session_id // empty' <<<"${input}")

  [[ -n ${session_id} && -n ${session_cwd} ]] || exit 0

  # Export for use in summarise_conversation (runs backgrounded).
  readonly SESSION_CWD="${session_cwd}"
  readonly SESSION_ID="${session_id}"

  mkdir -p "${LOG_DIR}" 2>/dev/null || true

  summarise_conversation </dev/null &
}

main
exit 0
